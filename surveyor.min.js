function Strip1(){var a,e=document.getElementById("strip1-fg"),i=e.getContext("2d"),t=viewportWidth/2,r=viewportHeight/2,n=t,o=r,s=!1,d=175,l=1.5,h=210,g=125,p=1.5,f=1,c=140,m=60,u=0,w=i.createLinearGradient(0,0,0,viewportHeight);w.addColorStop(0,"transparent"),w.addColorStop(1,"rgba(203, 170, 237, 0.8)");var v=new Image;v.src=DIR+"stars.gif";var S=0,y=2e-4,F=[new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,105,60),new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,140,120),new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,60,180),new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,90,240),new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,75,300),new Firefly((viewportWidth-16)*Math.random()+8,(viewportHeight-16)*Math.random()+8,130,0)],I=[],b=[],x=[];for(a=1;41>=a;a++)x.push(new Frame(DIR+"cars"+zeroFill(a,2)+".gif",33.333*a));for(a=0;86>a;a++)I.push(new Frame(DIR+"reeds/reed1"+zeroFill(a,2)+".png",33.333*a)),b.push(new Frame(DIR+"reeds/reed2"+zeroFill(a,2)+".png",33.333*a));b.push(new Frame(DIR+"reeds/reed286.png",2866.638));var R=[new Sprite(0,0,{imgSrc:DIR+"rocks.png",blendmode:"destination-over"}),new Sprite(0,0,{imgSrc:DIR+"streetlights.png",blendmode:"destination-over"}),new Sprite(0,0,{frames:x,length:5200,blendmode:"destination-over"})],D=[new Sprite(0,0,{imgSrc:DIR+"lighted.png",shadowImgSrc:DIR+"lighted-shadow.png"})],M=[new Sprite(0,0,{frames:I,length:2866.638}),new Sprite(0,0,{frames:b,length:2899.971}),new Sprite(0,0,{imgSrc:DIR+"grass.png"})];this.tick=function(){if(isVisible(1)){i.clearRect(0,0,viewportWidth,viewportHeight);var e,t=F.length;for(e=0;t>e;e++)this.renderFirefly(F[e]);for(this.renderSelf(),t=D.length,e=0;t>e;e++)this.renderSprite(D[e]);for(t=R.length,e=0;t>e;e++)this.renderSprite(R[e]);for(i.globalCompositeOperation="destination-over",i.fillStyle=w,i.fillRect(0,0,viewportWidth,viewportHeight),i.translate(viewportWidth/2,viewportHeight/2),i.rotate(S),i.drawImage(v,1.5*-viewportWidth,1.5*-viewportHeight,3*viewportWidth,3*viewportHeight),S+=y,i.setTransform(1,0,0,1,0,0),u=0,t=F.length,e=0;t>e;e++)this.renderFirefly(F[e]),this.tickFirefly(F[e]),F[e].follow&&u++;for(this.renderSelf(),this.tickSelf(),t=M.length,e=0;t>e;e++)this.renderSprite(M[e]);6===u?s||(s=!0,dialogManager.displayDialog(1,"dialog1-1")):s&&(s=!1,dialogManager.restoreDialog(1))}},this.renderSelf=function(){var e=i.createRadialGradient(n,o,0,n,o,d/2);e.addColorStop(0,"rgb(204, 204, 160)"),e.addColorStop(.1,"rgba(77, 77, 68, 0.5)"),e.addColorStop(.33,"rgba(66, 66, 66, 0.3)"),e.addColorStop(1,"transparent"),i.globalCompositeOperation="screen",i.fillStyle=e,i.fillRect(n-d/2,o-d/2,d,d)},this.renderFirefly=function(e){var t=i.createRadialGradient(e.x,e.y,0,e.x,e.y,e.size/2);t.addColorStop(0,"rgb(153, 153, 153)"),t.addColorStop(.1,"rgba(61, 61, 61, 0.5)"),t.addColorStop(.33,"rgba(40, 40, 40, 0.3)"),t.addColorStop(1,"transparent"),i.globalCompositeOperation="screen",i.fillStyle=t,i.fillRect(e.x-e.size/2,e.y-e.size/2,e.size,e.size)},this.tickSelf=function(){if(Math.abs(t-n)>1||Math.abs(r-o)>1){var e=t-n,i=e/8;n+=i,e=r-o,i=e/8,o+=i}(d>h||g>d)&&(l*=-1),d+=l},this.tickFirefly=function(e){var i=n-e.x,t=o-e.y,r=Math.abs(i),a=Math.abs(t);if((e.size>c||e.size<m)&&(e.dsize*=-1),e.size+=e.dsize,60>r&&60>a?e.follow=!0:(r>90||a>90)&&(e.follow=!1),e.follow&&(r>8||a>8)){var s=i/14;s>10&&(s=10),e.x+=s,s=t/14,s>10&&(s=10),e.y+=s}e.angle+=f*Math.PI/180,e.x+=p*Math.cos(e.angle),e.y+=p*Math.sin(e.angle),e.x>viewportWidth?e.x=viewportWidth:e.x<0&&(e.x=0),e.y>viewportHeight?e.y=viewportHeight:e.y<0&&(e.y=0)},this.renderSprite=function(e){if(i.scale(wScaleFactor,wScaleFactor),void 0!==e.img)void 0!==e.shadow?(i.globalCompositeOperation="source-atop",i.drawImage(e.img,2e3-e.img.width-e.x,2e3*viewportHeight/viewportWidth-e.img.height-e.y),i.globalCompositeOperation="destination-over",i.drawImage(e.shadow,2e3-e.img.width-e.x,2e3*viewportHeight/viewportWidth-e.img.height-e.y)):(i.globalCompositeOperation=e.blendmode,i.drawImage(e.img,2e3-e.img.width-e.x,2e3*viewportHeight/viewportWidth-e.img.height-e.y));else{if(void 0===e.frames)throw i.scale(1/wScaleFactor,1/wScaleFactor),new TypeError("A sprite in the scene must be regular, lighted, or animated.");i.globalCompositeOperation=e.blendmode;var t=e.getFrame(timeElapsed).img;i.drawImage(t,2e3-t.width-e.x,2e3*viewportHeight/viewportWidth-t.height-e.y)}i.scale(1/wScaleFactor,1/wScaleFactor)},this.handleMouse=function(e){void 0!==e.pageX&&void 0!==e.pageY?(t=e.pageX,r=e.pageY):(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,r=e.clientY+document.body.scrollTop+document.documentElement.scrollTop)},this.forceRedraw=function(){i.canvas.width=viewportWidth,i.canvas.height=viewportHeight,w=i.createLinearGradient(0,0,0,viewportHeight),w.addColorStop(0,"transparent"),w.addColorStop(1,"rgba(203, 170, 237, 0.8)")},this.init=function(){i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,this.forceRedraw(),document.getElementById("strip1").addEventListener("mousemove",strip1.handleMouse,!1)}}function Strip2(){var l,e=document.getElementById("strip2-fg"),i=e.getContext("2d"),t=viewportWidth/2,r=viewportHeight/2,n=t,a=[],s=[],d=[];for(l=0;173>l;l++)a.push(new Frame(DIR+"fire/fire"+zeroFill(l,3)+".png",33.333*l));for(l=87;173>l;l++)s.push(new Frame(DIR+"fire/fire"+zeroFill(l,3)+".png",33.333*(l-87)));for(l=0;87>l;l++)s.push(new Frame(DIR+"fire/fire"+zeroFill(l,3)+".png",33.333*(l+86)));for(l=0;111>l;l++)d.push(new Frame(DIR+"2jarfirefly-ss.png",33.333*l,122*l,0,122,109));var h=new Sprite(1235,"0.61",{frames:a,length:173*33.333,depth:70}),g=new Sprite(1235,"0.61",{frames:s,length:173*33.333,depth:70,name:"fire"}),p=7,f=8,c=9,m=10,u=[new Sprite("0.5","0.5",{imgSrc:DIR+"2mountains.png",depth:1e4}),new Sprite("0.5","0.5",{imgSrc:DIR+"2trees2.png",depth:150}),new Sprite("0.5","0.5",{imgSrc:DIR+"2trees1.png",depth:90}),new Sprite("0.5","0.5",{imgSrc:DIR+"2bank.png",depth:70}),new Sprite("0.5","0.5",{imgSrc:DIR+"2onbank.png",depth:70}),new Sprite(822,"0.78",{imgSrc:DIR+"2radio.png",depth:70,name:"radio"}),new Sprite(1615,"0.64",{imgSrc:DIR+"2noah.png",depth:70,name:"noah"}),null,null,new Sprite(1775,"0.785",{frames:d,depth:70,length:110*33.333,scale:.667}),new Sprite(1820,"0.79",{imgSrc:DIR+"2jar.png",depth:70,name:"jar"}),new Sprite("0.5","0.5",{imgSrc:DIR+"2overhang.png",depth:5})],w=new Sprite(1750,"0.66",{frames:d,depth:70,length:110*33.333}),v=[5,6,m];this.tick=function(){if(isVisible(2)){var r,e=t-n,o=u.length;for(Math.abs(e)>=1&&(n+=e/4,n=~~(n+.5)),i.clearRect(0,0,viewportWidth,viewportHeight),r=0;o>r;r++)this.renderSprite(u[r])}},this.renderSprite=function(e){if(null!==e){var t,r,o,a,s;if(i.scale(hScaleFactor,hScaleFactor),void 0!==e.img)t=e.img;else if(void 0!==e.frames){var d=e.getFrame(timeElapsed);t=d.img,d.isClipped&&(r=d.sx,o=d.sy,a=d.swidth,s=d.sheight)}if(void 0===t)throw i.scale(1/hScaleFactor,1/hScaleFactor),new TypeError("Sprite must have an image or frames.");if(void 0===e.depth)throw i.scale(1/hScaleFactor,1/hScaleFactor),new TypeError("Sprite must have parallax fields be defined.");var l="string"==typeof e.x?parseFloat(e.x)*viewportWidth:viewportWidth/2+(e.x-1250)*hScaleFactor,h="string"==typeof e.y?parseFloat(e.y)*viewportHeight:e.y*hScaleFactor;void 0===r?i.drawImage(t,Math.round((l+800*(viewportWidth/2-n)/(e.depth*viewportWidth))/hScaleFactor-t.width/2),Math.round(h/hScaleFactor-t.height/2),t.width*e.scale,t.height*e.scale):i.drawImage(t,r,o,a,s,Math.round((l+800*(viewportWidth/2-n)/(e.depth*viewportWidth))/hScaleFactor-a/2),Math.round(h/hScaleFactor-s/2),a*e.scale,s*e.scale),i.scale(1/hScaleFactor,1/hScaleFactor)}},this.changeToNight=function(){dialogManager.setOverlay(2,"#000000",{duration:400,opacity:1,callback:function(){u[p]=h,u[f]=g,v.push(f)}}),dialogManager.setOverlay(2,"#020204",{opacity:0,duration:400}),$("#strip2").animate({backgroundColor:"#000000"},12e3,"linear"),dialogManager.setOverlay(2,"#020204",{opacity:.6,duration:12e3})},this.openJar=function(){dialogManager.setOverlay(2,"#000000",{duration:400,opacity:1,callback:function(){u[c]=w}}),dialogManager.setOverlay(2,"#020204",{opacity:0,duration:400})},this.handleMouse=function(i){void 0!==i.pageX&&void 0!==i.pageY?(t=i.pageX,r=i.pageY):(t=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,r=i.clientY+document.body.scrollTop+document.documentElement.scrollTop),t-=e.offsetLeft,r-=viewportHeight,document.body.style.cursor=null!==strip2.checkClicked(t,r)?"pointer":"default"},this.handleClick=function(e){var i=e.pageX,t=e.pageY-viewportHeight;switch(console.log("click@ "+i+", "+t+", return: "+strip2.checkClicked(i,t)),strip2.checkClicked(i,t)){case"radio":dialogManager.displayDialog(2,"radio");break;case"noah":dialogManager.displayDialog(2,"noah");break;case"jar":dialogManager.displayDialog(2,"jar");break;case"fire":dialogManager.displayDialog(2,"fire")}},this.checkClicked=function(e,i){for(l=0;l<v.length;l++){{var t=u[v[l]],r=t.img||t.getFrame(0).img,n="string"==typeof t.x?parseFloat(t.x)*viewportWidth:viewportWidth/2+(t.x-1250)*hScaleFactor;"string"==typeof t.y?parseFloat(t.y)*viewportHeight:t.y*hScaleFactor}if(void 0!==t.name&&e>n+800*(viewportWidth/2-e)/(t.depth*viewportWidth)-r.width*hScaleFactor/2&&e<n+800*(viewportWidth/2-e)/(t.depth*viewportWidth)+r.width*hScaleFactor/2&&i>t.y*viewportHeight-r.height*hScaleFactor/2&&i<t.y*viewportHeight+r.height*hScaleFactor/2&&0===$(".dialog:hover").length)return t.name}return null},this.forceRedraw=function(){i.canvas.width=viewportWidth,i.canvas.height=viewportHeight},this.init=function(){i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,this.forceRedraw(),document.getElementById("strip2").addEventListener("mousemove",strip2.handleMouse,!1),document.getElementById("strip2").addEventListener("click",strip2.handleClick,!1)}}function Strip3(){var e=document.getElementById("strip3-fg"),i=e.getContext("2d"),t=viewportWidth/2,r=viewportHeight/2,n={x:0,dx:2,sprite:new Sprite(0,0,{imgSrc:DIR+"test2.png"}),render:function(){i.drawImage(this.sprite.img,(viewportWidth-this.sprite.img.width)/2,viewportHeight/2)}},o={sprite:new Sprite(0,0,{imgSrc:DIR+"test1.png"}),render:function(){i.drawImage(this.sprite.img,(viewportWidth-this.sprite.img.width)/2,viewportHeight/2)}},a=[new Sprite(30,95,{imgSrc:DIR+"test4.png"}),new Sprite(100,95,{imgSrc:DIR+"test3.png"}),new Sprite(160,95,{imgSrc:DIR+"test2.png"}),new Sprite(220,95,{imgSrc:DIR+"test1.png"}),new Sprite(320,95,{imgSrc:DIR+"test4.png"}),new Sprite(440,95,{imgSrc:DIR+"test3.png"}),new Sprite(500,95,{imgSrc:DIR+"test2.png"}),new Sprite(710,95,{imgSrc:DIR+"test1.png"}),new Sprite(900,95,{imgSrc:DIR+"test3.png"}),new Sprite(999,95,{imgSrc:DIR+"test2.png"})],s=1e3;this.tick=function(){isVisible(3)&&(i.clearRect(0,0,viewportWidth,viewportHeight),viewportWidth/2>t?n.dx>0&&(n.dx*=-1):n.dx<0&&(n.dx*=-1),n.x+=n.dx,n.x>0?n.x%=s:n.x+=s,this.render())},this.render=function(){var e,i=a.length;for(e=0;i>e;e++)this.renderSprite(a[e]);n.render(),o.render()},this.renderSprite=function(e){void 0!==e.img&&(n.x-300<e.x&&e.x<n.x+1200&&i.drawImage(e.img,e.x-n.x,e.y),n.x-300<e.x+s&&e.x+s<n.x+1200&&i.drawImage(e.img,e.x+s-n.x,e.y),n.x-300<e.x+s&&e.x-s<n.x&&i.drawImage(e.img,e.x-s-n.x,e.y))},this.handleMouse=function(i){void 0!==i.pageX&&void 0!==i.pageY?(t=i.pageX,r=i.pageY):(t=i.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,r=i.clientY+document.body.scrollTop+document.documentElement.scrollTop),t-=e.offsetLeft,r-=e.offsetTop},this.forceRedraw=function(){i.canvas.width=viewportWidth,i.canvas.height=viewportHeight,n.sprite.x=viewportWidth/2,n.sprite.y=viewportHeight/2,o.sprite.x=viewportWidth/2,o.sprite.y=viewportHeight/2},this.init=function(){i.mozImageSmoothingEnabled=!1,i.webkitImageSmoothingEnabled=!1,i.msImageSmoothingEnabled=!1,i.imageSmoothingEnabled=!1,this.forceRedraw(),document.getElementById("strip3").addEventListener("mousemove",strip3.handleMouse,!1)}}function DialogManager(){var s,e=140,i=160,t=1500,r=$({}),n={},o={},a={};for(s=1;NUM_STRIPS>=s;s++)o[s]=!1,a[s]=!1;this.putChoice=function(e,i){n[e]=i,refreshConditionalDisplay(e)},this.getChoice=function(e){return n[e]},this.displayDialog=function(t,n){if(o[t]!==n){var a=function(){$("#"+n).slideDown(e)},s=o[t];s!==!1?r.finish().queue("fx",function(){$("#"+s).fadeOut(i,a).dequeue()}):r.finish().queue("fx",function(){$("#strip"+t+"-text").fadeOut(i,a).dequeue()}),o[t]=n}},this.hideDialog=function(e){var t=o[e];t!==!1?r.finish().queue("fx",function(){$("#"+t).fadeOut(i).dequeue()}):r.finish().queue("fx",function(){$("#strip"+e+"-text").fadeOut(i).dequeue()})},this.restoreDialog=function(e){var n=function(){$("#strip"+e+"-text").fadeIn(t)},a=o[e];a!==!1?r.finish().queue("fx",function(){$("#"+a).fadeOut(i,n).dequeue()}):r.finish().queue("fx",function(){$("#strip"+e+"-text").fadeOut(i,n).dequeue()}),o[e]=!1},this.setOverlay=function(e,i,t){var r=void 0===t.duration?1e4:t.duration,n=void 0===t.opacity?$("overlay"+e).css("opacity"):t.opacity,o=t.callback||function(){};a[e]?$("#overlay"+e).animate({backgroundColor:i,opacity:n},r,"linear",o):(1001>r&&(a[e]=!0),$("#overlay"+e).finish().animate({backgroundColor:i,opacity:n},r,"linear",function(){o(),a[e]=!1}))}}function Sprite(e,i,t){this.x=e,this.y=i;var r;if(void 0!==t.imgSrc&&(r=new Image,r.src=t.imgSrc,this.img=r),void 0!==t.shadowImgSrc&&(r=new Image,r.src=t.shadowImgSrc,this.shadow=r),this.name=t.name,this.frames=t.frames,this.length=t.length,this.depth=t.depth,this.blendmode=t.blendmode||"normal",this.scale=t.scale||1,this.sx=t.sx,this.sy=t.sy,this.swidth=t.swidth,this.sheight=t.sheight,void 0!==this.frames&&void 0===this.length)throw new TypeError("Define a duration for the animation!");this.getFrame=function(e){if(void 0!==this.frames&&void 0!==this.length){e%=this.length;var t,i=this.frames[0],r=this.frames.length;for(t=0;r>t;t++){var n=this.frames[t];if(!(e>n.timestamp)){if(e===n.timestamp)return n;break}i=n}return i}return null}}function Frame(e,i,t,r,n,o){var a=new Image;if(a.src=e,this.img=a,this.isClipped=void 0!==t,this.isClipped&&(this.sx=t,this.sy=r,this.swidth=n,this.sheight=o),this.timestamp=i,void 0===i)throw new TypeError("Define a timestamp for the frame!")}function Firefly(e,i,t,r){this.x=e,this.y=i,this.size=t,this.dsize=Math.random()<.5?-1:1,this.angle=r*Math.PI/180,this.follow=!1}function forceRedraw(){viewportWidth=viewport().width,viewportHeight=viewport().height,wScaleFactor=viewportWidth/2e3,hScaleFactor=viewportHeight/1e3,strip1.forceRedraw(),strip2.forceRedraw(),strip3.forceRedraw()}function tickAll(){setTimeout(function(){window.requestAnimFrame(tickAll),timeElapsed=Date.now()-START_TIME,strip1.tick(),strip2.tick()},1e3/30)}function viewport(){var e=$("#strip1"),i=e.height(),t=e.width();return{width:t,height:i}}function isVisible(e){var i=document.documentElement&&document.documentElement.scrollTop||document.body.scrollTop,t=viewport().height,r=[!1,!1,!1,!1,!1];return 0===i?r[0]=!0:t>i?r[0]=r[1]=!0:i===t?r[1]=!0:2*t>i?r[1]=r[2]=!0:i===2*t?r[2]=!0:3*t>i?r[2]=r[3]=!0:i>=3*t&&(r[3]=!0),r[e-1]}function zeroFill(e,i){for(e=e.toString();e.length<i;)e="0"+e;return e}function displayDialog(e,i){dialogManager.displayDialog(e,i)}function restoreDialog(e){dialogManager.restoreDialog(e)}function setOverlay(e,i,t){dialogManager.setOverlay(e,i,t)}function putChoice(e,i){dialogManager.putChoice(e,i),console.log("Set "+e+" to "+dialogManager.getChoice(e))}function getChoice(e){return dialogManager.getChoice(e)}function refreshConditionalDisplay(e){console.log("Refreshed conditional text display!"),("needToLightFire"===e||void 0===e)&&($(".needToLightFire").toggle(getChoice("needToLightFire")===!0),$(".notNeedToLightFire").toggle(getChoice("needToLightFire")!==!0)),("radioListen1"!==e&&void 0!==e||($(".slept").toggle(void 0!==getChoice("radioListen1")),$(".notSlept").toggle(void 0===getChoice("radioListen1")),$(".rememberedFireflies").toggle("party"===getChoice("radioListen1")),$(".notRememberedFireflies").toggle("party"!==getChoice("radioListen1")),"string"!=typeof e))&&("isJarOpen"!==e&&void 0!==e||($(".isJarOpen").toggle(getChoice("isJarOpen")===!0),$(".notIsJarOpen").toggle(getChoice("isJarOpen")!==!0),"string"!=typeof e))&&("fireLit"===e||void 0===e)&&($(".fireLit").toggle(getChoice("fireLit")===!0),$(".notFireLit").toggle(getChoice("fireLit")!==!0),"string"==typeof e)}function debug(){setInterval(function(){var e="";isVisible(1)&&(e+="1 "),isVisible(2)&&(e+="2 "),isVisible(3)&&(e+="3 "),isVisible(4)&&(e+="4 ")},3e3)}var viewportWidth=viewport().width,viewportHeight=viewport().height,wScaleFactor=viewportWidth/2e3,hScaleFactor=viewportHeight/1e3,START_TIME=Date.now(),timeElapsed=0,DIR="assets/",NUM_STRIPS=4,dialogManager=new DialogManager,strip1=new Strip1,strip2=new Strip2,strip3=new Strip3;strip1.init(),strip2.init(),strip3.init(),window.addEventListener("resize",forceRedraw,!1),refreshConditionalDisplay(),tickAll(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();